/******************************************************************************
 * @brief    环形缓冲区管理(参考linux/kfifo)
 *
 * Copyright (c) 2016~2020, <zgdyx2014@163.com>
 *
 * SPDX-License-Identifier: Apache-2.0
 *
 * Change Logs: 
 * Date           Author       Notes 
 * 2016-05-30     Morro        初版完成
 ******************************************************************************/

/*==================================================================================================
*                                        INCLUDE FILES
* 1) system and project includes
* 2) needed interfaces from external units
* 3) internal and external interfaces from this unit
==================================================================================================*/
#include "ringbuffer.h"
#include <string.h>
#include <stddef.h>

/*==================================================================================================
*                              SOURCE FILE VERSION INFORMATION
==================================================================================================*/

/*==================================================================================================
*                                       LOCAL MACROS
==================================================================================================*/
#define min(a,b) ( (a) < (b) )? (a):(b)     
     
/*==================================================================================================
*                          LOCAL TYPEDEFS (STRUCTURES, UNIONS, ENUMS)
==================================================================================================*/


/*==================================================================================================
*                                      LOCAL CONSTANTS
==================================================================================================*/

/*==================================================================================================
*                                      LOCAL VARIABLES
==================================================================================================*/


/*==================================================================================================
*                                      GLOBAL CONSTANTS
==================================================================================================*/

/*==================================================================================================
*                                      GLOBAL VARIABLES
==================================================================================================*/


/*==================================================================================================
*                                   LOCAL FUNCTION PROTOTYPES
==================================================================================================*/


/*==================================================================================================
*                                       GLOBAL FUNCTIONS
==================================================================================================*/

/*FUNCTION**********************************************************************
 *
 * @brief 		:	构造一个空环形缓冲区
 * @details 	:
 *
 * @param[in] 	:  	r    - 环形缓冲区管理器
 * 					buf  - 数据缓冲区
 * 					len  - buf长度(必须是2的N次幂)
 * @return 		: 	bool
 *END**************************************************************************/
bool ring_buf_init(ring_buf_t *r,unsigned char *buf, unsigned int len)
{
    r->buf    = buf;
    r->size   = len;
    r->front  = r->rear = 0;
    return ((NULL != buf) && (0 == (len & (len -1))));
}

/*FUNCTION**********************************************************************
 *
 * @brief 		:	清空环形缓冲区
 * @details 	:
 *
 * @param[in] 	:  	r - 待清空的环形缓冲区
 * @return 		: 	none
 *END**************************************************************************/
void ring_buf_clr(ring_buf_t *r)
{
    r->front = r->rear = 0;
}

/*FUNCTION**********************************************************************
 *
 * @brief 		:	获取环形缓冲区数据长度
 * @details 	:
 *
 * @param[in] 	:
 * @return 		: 	环形缓冲区中有效字节数
 *END**************************************************************************/
unsigned int ring_buf_len(ring_buf_t *r)
{
    return (r->rear - r->front);
}

/*FUNCTION**********************************************************************
 *
 * @brief 		:	将指定长度的数据放到环形缓冲区中
 * @details 	:
 *
 * @param[in] 	:  	buf - 数据缓冲区
 * 					len - 缓冲区长度
 * @return 		: 	实际放到中的数据
 *END**************************************************************************/
unsigned int ring_buf_put(ring_buf_t *r,unsigned char *buf,unsigned int len)
{
    unsigned int i;
    unsigned int left;
    left = r->size + r->front - r->rear;
    len  = min(len , left);
    i    = min(len, r->size - (r->rear & (r->size - 1)));
    memcpy(r->buf + (r->rear & (r->size - 1)), buf, i);
    memcpy(r->buf, buf + i, len - i);
    r->rear += len;     

    return len;
}

/*FUNCTION**********************************************************************
 *
 * @brief 		:	从环形缓冲区中读取指定长度的数据
 * @details 	:
 *
 * @param[in] 	:  	len - 读取长度
 * 					buf - 输出数据缓冲区
 * @return 		: 	实际读取长度
 *END**************************************************************************/
unsigned int ring_buf_get(ring_buf_t *r, unsigned char *buf, unsigned int len)
{
    unsigned int i;
    unsigned int left;    
    left = r->rear - r->front;
    len  = min(len , left);                                
    i    = min(len, r->size - (r->front & (r->size - 1)));
    memcpy(buf, r->buf + (r->front & (r->size - 1)), i);
    memcpy(buf + i, r->buf, len - i);   
    r->front += len;

    return len;
}

/*#^v^#*/
